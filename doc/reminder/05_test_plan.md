# 5. テスト計画書

## 5.1. テストの目的

リマインダー機能が仕様書通りに動作し、エッジケースや異常系においても安定して動作することを確認する。

## 5.2. テストの種類

- **単体テスト (Unit Tests)**: 個別の関数やモジュールが正しく動作することを確認する。
- **結合テスト (Integration Tests)**: Discord API や Google Sheets API と連携させた状態で、コマンドの実行から通知までの一連のフローをテストする。
- **手動テスト (Manual Tests)**: 実際の Discord 環境で、ユーザー操作によるシナリオベースのテストを実施する。

## 5.3. テストケース

### 5.3.1. 単体テストケース

- **時刻パーサー (`time` 引数の処理)**
    - [ ] **正常系**:
        - [ ] "明日 15時"
        - [ ] "10分後"
        - [ ] "3日後"
        - [ ] "来週の火曜日 19:00"
        - [ ] "1時間後"
        - [ ] "2026-01-20T12:00:00"
        - [ ] "毎日 10:00"
    - [ ] **異常系**:
        - [ ] "昨日 10時" (過去の時刻)
        - [ ] "あいうえお" (無効な文字列)
        - [ ] 空文字列

- **繰り返し時刻計算ロジック**
    - [ ] **`daily`**: 24時間後の時刻が正しく計算されるか。
    - [ ] **`weekly`**: 7日後の時刻が正しく計算されるか。
    - [ ] **`monthly`**:
        - [ ] 3月15日 -> 4月15日
        - [ ] 1月31日 -> 2月28日 (または29日)
        - [ ] 12月31日 -> 1月31日

- **権限チェックロジック**
    - [ ] `scope=server` の `delete` コマンドを管理者以外のユーザーが実行した場合にエラーとなるか。
    - [ ] `scope=channel` の操作で、チャンネル管理権限を持たないユーザーが拒否されるか。

### 5.3.2. 結合テストケース

- **`/remind add` フロー**
    - [ ] **正常系**: コマンド実行後、Google Sheets に正しくデータが書き込まれるか。
        - [ ] `scope=user`
        - [ ] `scope=channel`
        - [ ] `scope=server`
        - [ ] 自動生成された8文字の `key` がレスポンスおよびシートに記録されるか。
    - [ ] **異常系**:
        - [ ] 必須引数が欠けている場合にエラーが返るか。

- **スケジューラと通知フロー**
    - [ ] `notify_time_utc` を過ぎた `pending` のリマインダーが、スケジューラによって `sending` に更新されるか。
    - [ ] Discord に正しく通知が送信されるか (DM, チャンネル投稿)。
    - [ ] 送信成功後、`status` が `sent` に更新され、`last_sent` が記録されるか。
    - [ ] 繰り返し設定 (`recurring`) がある場合、次回の `notify_time_utc` が正しく更新されるか。
    - [ ] **リトライ処理**:
        - [ ] Discord APIへの送信が失敗した場合 (Mock)、`retry_count` がインクリメントされ、`status` が `pending` に戻るか。
        - [ ] リトライ回数が上限に達した場合、`status` が `failed` になるか。

### 5.3.3. 手動テストシナリオ

- **一般的な利用シナリオ**
    - [ ] ユーザーが個人のリマインダーを登録し、DMで通知を受け取る。
    - [ ] チャンネルの会議リマインダーを登録し、チャンネルで通知を受け取る。
    - [ ] `list` コマンドで登録済みリマインダーを確認する。
    - [ ] `delete` コマンドでリマインダーを削除する（確認フローあり）。
    - [ ] 自動生成された8文字の `key` を `list` から確認し、削除に利用できるか。

- **UX/UIテスト**
    - [ ] エラーメッセージは分かりやすいか。
    - [ ] 時刻パース失敗時に、正しいフォーマット例が提示されるか。
    - [ ] `list` コマンドの表示は見やすいか。
