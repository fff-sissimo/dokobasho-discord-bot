# 1. リマインダー機能仕様書

本書は、Discord ボットに実装するリマインダー機能の仕様を定義する。

## 1.1. 目的

- Discord ボットに `/remind` サブコマンド群を実装する。
- 永続化は Google Sheets（シート名: Reminders）を利用する。
- 確実に通知されるスケジューラを別プロセスで実装する。

## 1.2. コマンド仕様

### 1.2.1. `/remind add`

リマインダーを新規登録する。

- **引数:**
    - `key`: `string` (必須, 1-100文字) - リマインダーを識別するためのユニークなキー。
    - `time`: `string` (必須) - 通知時刻。自然言語（例: 「明日の15時」「3日後」）および ISO 8601 形式 (`YYYY-MM-DDTHH:mm:ss`) を受け付ける。
    - `content`: `string` (必須, 1-2000文字) - リマインド内容。
    - `scope`: `enum` (`user` | `channel` | `server`, デフォルト: `user`) - リマインダーの公開範囲。
    - `visibility`: `enum` (`public` | `ephemeral`, デフォルト: `ephemeral` ※scope=`user`の場合) - 応答の可視性。
    - `recurring`: `enum` (`off` | `daily` | `weekly` | `monthly`, デフォルト: `off`) - 繰り返しの設定。
    - `timezone`: `string` (任意) - `time`引数の解釈に用いるタイムゾーン（例: `Asia/Tokyo`）。指定がない場合はユーザー設定またはサーバーのデフォルト設定を利用。
    - `overwrite`: `boolean` (任意, デフォルト: `false`) - `true` の場合、同一 `scope` + `key` のリマインダーが存在すれば上書きする。
- **挙動:**
    - 同一 `scope` + `key` のリマインダーが存在し、`overwrite` が `false` の場合はエラーを返す。
    - `time` のパースに失敗した場合は、具体的な入力例を提示してエラーを返す。
    - 登録成功時、登録内容のサマリーを返す。

### 1.2.2. `/remind get`

特定のリマインダー詳細情報を取得する。

- **引数:**
    - `key`: `string` (必須) - 取得したいリマインダーのキー。
    - `scope`: `enum` (`user` | `channel` | `server`, 必須) - リマインダーの公開範囲。
- **挙動:**
    - 指定されたリマインダーの詳細情報を返す。時刻はユーザーのローカルタイムゾーンで表示する。
    - 存在しない場合は、その旨をメッセージで返す。

### 1.2.3. `/remind list`

リマインダーの一覧を表示する。

- **引数:**
    - `scope`: `enum` (`user` | `channel` | `server`, 必須) - 一覧表示するリマインダーの公開範囲。
    - `query`: `string` (任意) - `key` または `content` を対象にフィルタリングする文字列。
    - `limit`: `integer` (任意, デフォルト: 50) - 表示する最大件数。
- **挙動:**
    - 条件に合致するリマインダーを箇条書きで一覧表示する（項目: key, 次回通知時刻, 繰り返し設定, contentの短縮版）。

### 1.2.4. `/remind delete`

リマインダーを削除する。

- **引数:**
    - `key`: `string` (必須) - 削除したいリマインダーのキー。
    - `scope`: `enum` (`user` | `channel` | `server`, 必須) - リマインダーの公開範囲。
    - `confirm`: `boolean` (任意, デフォルト: `false`) - `true` の場合に削除を確定する。`false` の場合は確認メッセージを出す。
- **挙動:**
    - `confirm=true` の場合、リマインダーを削除し、完了メッセージを返す。
    - `scope` が `server` のリマインダーを削除するには、実行者に管理者権限が必要。
    - `confirm=false` の場合は、削除の最終確認を促すメッセージとボタンを表示する。

## 1.3. 通知と表示

- **通知方法:**
    - `user` scope: ユーザーへのダイレクトメッセージ（DM）で通知する。
    - `channel` scope: 指定チャンネルに投稿する。
    - `server` scope: サーバーの指定チャンネル（またはアナウンス用チャンネル）に投稿する。
- **表示形式:**
    - 成功時の応答は、簡潔なサマリーとする。
        - 例: `✅ リマインダー登録完了 — key: 学習 / 次回: 2026-01-11 15:00 (JST) / scope: channel`
    - エラー時の応答は、原因と対処法を具体的に示す。
        - 例: `❌ 時刻の指定が正しくありません。「明日の10時」や「2026-01-11 15:00」のように指定してください。`
    - `list` コマンドの出力は、キー、次回通知時刻、繰り返し、内容の先頭60文字を一覧表示する。

## 1.4. 権限

- `server` スコープのリマインダー作成・削除は、サーバーの管理者権限を持つユーザーのみ操作可能。
- `channel` スコープのリマインダー作成・削除は、チャンネルの管理権限を持つユーザーに制限、またはボタンによる承認フローを導入することができる。
